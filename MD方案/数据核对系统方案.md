# 数据核对系统设计方案

## 一、系统概述

### 1.1 功能定位
数据核对系统是一个面向教师/管理员的评分辅助工具，用于：
- 快速评估学生设计方案的合理性
- 自动计算最优解作为评分参考
- 可视化展示方案运行效果
- 支持小组协作的全局优化评分

### 1.2 访问权限
- 仅管理员账号（学号11）可见
- 入口位于顶部状态栏，"管理面板"按钮右侧
- 按钮文字："数据核对"

---

## 二、核心算法设计

### 2.1 问题建模

#### 决策变量
对于每个区域，需要确定：
```
X = {
  windTurbines: [{model: string, count: number}, ...],     // 风机选型及数量
  solarPanels: [{model: string, count: number}, ...],      // 光伏板选型及数量
  biomassEquipment: [{model: string, count: number}, ...], // 生物质设备选型及数量
  batteries: [{model: string, count: number}, ...],        // 蓄电池选型及数量
  inverters: [{model: string, count: number}, ...],        // 逆变器等系统设备
}
```

#### 约束条件
1. **供需平衡约束**：任意时刻 `发电量 + 放电量 ≥ 负荷需求`
2. **设备匹配约束**：
   - 逆变器功率 ≥ 光伏装机容量
   - PCS功率 ≥ 电池最大充放电功率
   - 生物质设备链路完整（锅炉→汽轮机 或 气化炉→燃气机 或 发酵罐→沼气机）
3. **资源约束**：
   - 风机发电量受风速限制
   - 光伏发电量受辐照度限制
   - 生物质发电量受原料供应限制

#### 目标函数
```
minimize: 总投资成本 = Σ(设备单价 × 数量)
subject to: 全年8760小时供需平衡
```

### 2.2 求解策略

#### 方案A：枚举+剪枝（推荐用于教学场景）

由于设备种类和数量有限，采用智能枚举：

```typescript
// 伪代码
function findOptimalSolution(region: Region) {
  const solutions = [];
  
  // Step 1: 计算基础需求
  const peakLoad = getMaxLoad(region);           // 峰值负荷 (MW)
  const dailyEnergy = getDailyEnergy(region);    // 日均用电量 (MWh)
  const biomassAvailable = getBiomassYield(region); // 生物质可用量 (t/d)
  
  // Step 2: 确定搜索范围（剪枝）
  const windRange = calculateWindRange(peakLoad);      // 风机数量范围
  const solarRange = calculateSolarRange(peakLoad);    // 光伏数量范围
  const biomassRange = calculateBiomassRange(biomassAvailable); // 生物质设备范围
  const batteryRange = calculateBatteryRange(dailyEnergy);      // 储能容量范围
  
  // Step 3: 枚举所有可行组合
  for (windConfig of windRange) {
    for (solarConfig of solarRange) {
      for (biomassConfig of biomassRange) {
        for (batteryConfig of batteryRange) {
          const config = {windConfig, solarConfig, biomassConfig, batteryConfig};
          
          // 快速可行性检验
          if (!quickFeasibilityCheck(config, region)) continue;
          
          // 详细仿真验证
          const simulation = simulate8760Hours(config, region);
          
          if (simulation.feasible) {
            solutions.push({
              config,
              cost: calculateTotalCost(config),
              reliability: simulation.reliability,
              curtailment: simulation.curtailment
            });
          }
        }
      }
    }
  }
  
  // Step 4: 排序返回最优解
  return solutions.sort((a, b) => a.cost - b.cost);
}
```

#### 搜索空间估算
| 设备类型 | 型号数 | 数量范围 | 组合数 |
|---------|-------|---------|-------|
| 风机 | 5 | 0-20 | 100 |
| 光伏 | 6 | 0-5000(步长100) | 300 |
| 生物质路线 | 3 | 各2-3种设备 | 50 |
| 储能 | 5 | 0-100(步长10) | 50 |

总组合数：100 × 300 × 50 × 50 = 7500万

**优化策略**：
1. 先确定生物质路线（3选1），减少90%搜索空间
2. 根据负荷特性预估装机容量范围，缩小搜索区间
3. 使用并行计算加速

### 2.3 仿真模型

#### 8760小时仿真流程
```typescript
function simulate8760Hours(config: EquipmentConfig, region: Region) {
  const results = {
    hourlyGeneration: [],    // 逐时发电量
    hourlyLoad: [],          // 逐时负荷
    batterySOC: [],          // 电池SOC
    curtailment: [],         // 弃电量
    shortage: [],            // 缺电量
  };
  
  let batteryEnergy = config.batteryCapacity * 0.5; // 初始SOC 50%
  
  for (let hour = 0; hour < 8760; hour++) {
    const {month, day, h} = getDateTime(hour);
    
    // 1. 计算各类发电量
    const windPower = calculateWindPower(config.wind, region, month, day, h);
    const solarPower = calculateSolarPower(config.solar, region, month, day, h);
    const biomassPower = calculateBiomassPower(config.biomass, region);
    const totalGeneration = windPower + solarPower + biomassPower;
    
    // 2. 获取负荷需求
    const load = getLoad(region, month, day, h);
    
    // 3. 供需平衡计算
    const balance = totalGeneration - load;
    
    if (balance >= 0) {
      // 发电过剩：优先充电，剩余弃电
      const chargeAmount = Math.min(balance, config.maxChargeRate, 
                                     config.batteryCapacity - batteryEnergy);
      batteryEnergy += chargeAmount * config.chargeEfficiency;
      results.curtailment.push(balance - chargeAmount);
    } else {
      // 发电不足：优先放电，不足则缺电
      const dischargeNeed = -balance;
      const dischargeAmount = Math.min(dischargeNeed, config.maxDischargeRate,
                                        batteryEnergy * config.dischargeEfficiency);
      batteryEnergy -= dischargeAmount / config.dischargeEfficiency;
      results.shortage.push(dischargeNeed - dischargeAmount);
    }
    
    results.hourlyGeneration.push({wind: windPower, solar: solarPower, biomass: biomassPower});
    results.hourlyLoad.push(load);
    results.batterySOC.push(batteryEnergy / config.batteryCapacity);
  }
  
  return analyzeResults(results);
}
```

---

## 三、评分体系设计

### 3.1 评分维度（总分100分）

| 维度 | 权重 | 说明 |
|-----|-----|------|
| 工况满足 | 30分 | 全年供电可靠性 |
| 设备匹配 | 20分 | 设备间参数匹配度 |
| 经济性 | 30分 | 投资成本与最优解的差距 |
| 稳定性 | 10分 | 电池SOC波动、弃电率等 |
| 小组加分 | 10分 | 全局最优解贡献 |

### 3.2 各维度评分细则

#### 3.2.1 工况满足（30分）
```typescript
function scoreReliability(simulation: SimulationResult): number {
  const totalHours = 8760;
  const shortageHours = simulation.shortage.filter(s => s > 0).length;
  const reliabilityRate = (totalHours - shortageHours) / totalHours;
  
  if (reliabilityRate >= 0.999) return 30;      // 99.9%以上满分
  if (reliabilityRate >= 0.995) return 25;      // 99.5%以上
  if (reliabilityRate >= 0.99) return 20;       // 99%以上
  if (reliabilityRate >= 0.95) return 15;       // 95%以上
  if (reliabilityRate >= 0.90) return 10;       // 90%以上
  return 5;                                      // 90%以下
}
```

#### 3.2.2 设备匹配（20分）
```typescript
function scoreEquipmentMatching(config: EquipmentConfig): number {
  let score = 20;
  const issues = [];
  
  // 检查逆变器容量
  const pvCapacity = config.solarPanels.reduce((sum, p) => sum + p.power * p.count, 0);
  const inverterCapacity = config.inverters.reduce((sum, i) => sum + i.power * i.count, 0);
  if (inverterCapacity < pvCapacity * 0.9) {
    score -= 5;
    issues.push('逆变器容量不足');
  }
  
  // 检查生物质设备链路
  if (!checkBiomassChain(config.biomassEquipment)) {
    score -= 5;
    issues.push('生物质设备链路不完整');
  }
  
  // 检查电压等级匹配
  if (!checkVoltageCompatibility(config)) {
    score -= 5;
    issues.push('设备电压等级不匹配');
  }
  
  // 检查储能PCS匹配
  if (!checkPCSMatching(config)) {
    score -= 5;
    issues.push('储能PCS功率不匹配');
  }
  
  return {score, issues};
}
```

#### 3.2.3 经济性（30分）
```typescript
function scoreEconomics(studentCost: number, optimalCost: number): number {
  const ratio = studentCost / optimalCost;
  
  if (ratio <= 1.05) return 30;      // 成本在最优解105%以内
  if (ratio <= 1.10) return 25;      // 110%以内
  if (ratio <= 1.20) return 20;      // 120%以内
  if (ratio <= 1.30) return 15;      // 130%以内
  if (ratio <= 1.50) return 10;      // 150%以内
  return 5;                           // 超过150%
}
```

#### 3.2.4 稳定性（10分）
```typescript
function scoreStability(simulation: SimulationResult): number {
  let score = 10;
  
  // SOC波动评估
  const socStd = calculateStandardDeviation(simulation.batterySOC);
  if (socStd > 0.3) score -= 2;
  
  // 弃电率评估
  const curtailmentRate = sum(simulation.curtailment) / sum(simulation.hourlyGeneration);
  if (curtailmentRate > 0.1) score -= 3;
  if (curtailmentRate > 0.2) score -= 2;
  
  // 深度放电次数
  const deepDischargeCount = simulation.batterySOC.filter(soc => soc < 0.1).length;
  if (deepDischargeCount > 100) score -= 3;
  
  return Math.max(0, score);
}
```

#### 3.2.5 小组加分（10分）
```typescript
function scoreGroupBonus(groupSolutions: Solution[], globalOptimal: Solution): number {
  // 检查小组是否找到全局最优解（允许5%误差）
  const bestInGroup = groupSolutions.reduce((best, s) => 
    s.totalCost < best.totalCost ? s : best
  );
  
  const ratio = bestInGroup.totalCost / globalOptimal.totalCost;
  
  if (ratio <= 1.02) return 10;      // 2%以内视为找到最优解
  if (ratio <= 1.05) return 7;       // 5%以内
  if (ratio <= 1.10) return 5;       // 10%以内
  return 0;
}
```

---

## 四、全局优化模型

### 4.1 区域协作模型

```
全局目标：minimize Σ(各区域投资成本) + Σ(输送成本)

约束条件：
1. 各区域本地供需平衡 或 通过输送满足
2. 输送容量限制
3. 输送损耗计算
```

### 4.2 生物质运输成本折算
```typescript
// 生物质运输成本折算为等效电力成本
const BIOMASS_TRANSPORT_COST = 50;  // 元/吨·公里
const BIOMASS_HEAT_VALUE = 15;      // MJ/kg (平均热值)
const POWER_EFFICIENCY = 0.30;      // 发电效率

// 1吨生物质可发电量
const kWhPerTon = (BIOMASS_HEAT_VALUE * 1000 / 3.6) * POWER_EFFICIENCY; // ≈1250 kWh/t

// 运输成本折算
function transportCostToElectricity(distance: number): number {
  const transportCost = BIOMASS_TRANSPORT_COST * distance; // 元/吨
  const equivalentKWh = transportCost / 0.5; // 假设电价0.5元/kWh
  return equivalentKWh; // kWh/t 的等效损耗
}
```

### 4.3 电力输送模型
```typescript
// 电力输送损耗
const POWER_LOSS_RATE = 0.05;  // 5%/100km

function calculatePowerTransfer(from: Region, to: Region, power: number): number {
  const distance = getDistance(from, to);
  const lossRate = POWER_LOSS_RATE * (distance / 100);
  return power * (1 - lossRate);
}
```

---

## 五、界面设计

### 5.1 主界面布局

```
┌─────────────────────────────────────────────────────────────────┐
│  数据核对系统                                              [X]  │
├─────────────────────────────────────────────────────────────────┤
│ ┌─────────────────┐ ┌─────────────────────────────────────────┐ │
│ │ 输入区域        │ │ 评分结果                                │ │
│ │                 │ │                                         │ │
│ │ 区域选择: [▼]   │ │  总分: 85/100                          │ │
│ │                 │ │  ├─ 工况满足: 25/30                     │ │
│ │ ─────────────── │ │  ├─ 设备匹配: 18/20                     │ │
│ │ 风机选型:       │ │  ├─ 经济性:   25/30                     │ │
│ │ [型号▼] [数量]  │ │  ├─ 稳定性:   9/10                      │ │
│ │ [+ 添加]        │ │  └─ 小组加分: 8/10                      │ │
│ │                 │ │                                         │ │
│ │ 光伏选型:       │ │ ─────────────────────────────────────── │ │
│ │ [型号▼] [数量]  │ │ 问题诊断:                               │ │
│ │ [+ 添加]        │ │ ⚠ 逆变器容量略有不足                    │ │
│ │                 │ │ ✓ 生物质设备链路完整                    │ │
│ │ 生物质设备:     │ │ ✓ 储能配置合理                          │ │
│ │ [路线▼]         │ │                                         │ │
│ │ [设备1▼] [数量] │ │ ─────────────────────────────────────── │ │
│ │ [设备2▼] [数量] │ │ 最优解参考:                             │ │
│ │                 │ │ 投资成本: ¥1,250万 (学生: ¥1,380万)     │ │
│ │ 储能设备:       │ │ 差距: +10.4%                            │ │
│ │ [型号▼] [数量]  │ │                                         │ │
│ │                 │ │                                         │ │
│ │ 系统设备:       │ │                                         │ │
│ │ [型号▼] [数量]  │ │                                         │ │
│ │                 │ │                                         │ │
│ │ [开始评估]      │ │                                         │ │
│ └─────────────────┘ └─────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│ 可视化图表                                          [导出CSV]   │
│ ┌───────────────────────────────────────────────────────────┐   │
│ │ [发电曲线] [负荷曲线] [SOC曲线] [供需平衡] [资源流动]     │   │
│ │                                                           │   │
│ │     ▲                                                     │   │
│ │  MW │    ╱╲    ╱╲                                        │   │
│ │     │   ╱  ╲  ╱  ╲   ← 风电                              │   │
│ │     │  ╱    ╲╱    ╲                                      │   │
│ │     │ ╱            ╲  ← 光伏                             │   │
│ │     │╱──────────────╲ ← 生物质                           │   │
│ │     └────────────────────────────────────────────→ 时间   │   │
│ │                                                           │   │
│ └───────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 图表类型

1. **发电用电曲线**
   - 风电发电量（蓝色）
   - 光伏发电量（黄色）
   - 生物质发电量（绿色）
   - 负荷需求（红色虚线）
   - 可选：日/月/年视图

2. **蓄电池SOC曲线**
   - SOC百分比（紫色）
   - 充电区间（绿色填充）
   - 放电区间（红色填充）

3. **供需平衡图**
   - 盈余电量（绿色柱）
   - 缺口电量（红色柱）
   - 弃电量（灰色柱）

4. **资源流动图**（全局视图）
   - 各区域间电力流动
   - 各区域间生物质流动
   - 流量用线条粗细表示

---

## 六、数据导出

### 6.1 导出格式
所有图表数据均可导出为CSV格式：

```csv
# 发电数据导出示例
DateTime,WindPower(MW),SolarPower(MW),BiomassPower(MW),TotalGeneration(MW),Load(MW),Balance(MW),BatterySOC(%)
2024-01-01 00:00,12.5,0,5.0,17.5,15.2,2.3,52.1
2024-01-01 01:00,13.2,0,5.0,18.2,14.8,3.4,54.3
...
```

### 6.2 导出内容
- 全年8760小时逐时数据
- 月度汇总数据
- 设备配置清单
- 评分详情报告

---

## 七、实现计划

### 7.1 文件结构
```
energy-system/src/
├── DataVerification/
│   ├── DataVerificationPanel.tsx    # 主面板组件
│   ├── EquipmentInput.tsx           # 设备输入组件
│   ├── ScoreDisplay.tsx             # 评分展示组件
│   ├── SimulationCharts.tsx         # 图表组件
│   ├── OptimizationEngine.ts        # 优化求解引擎
│   ├── SimulationEngine.ts          # 仿真引擎
│   ├── ScoringEngine.ts             # 评分引擎
│   └── types.ts                     # 类型定义
```

### 7.2 开发阶段

| 阶段 | 内容 | 预计工作量 |
|-----|------|----------|
| 1 | 基础框架搭建、类型定义 | 1天 |
| 2 | 仿真引擎实现 | 2天 |
| 3 | 优化求解引擎 | 2天 |
| 4 | 评分系统实现 | 1天 |
| 5 | UI界面开发 | 2天 |
| 6 | 图表可视化 | 1天 |
| 7 | 数据导出功能 | 0.5天 |
| 8 | 测试与优化 | 1.5天 |

---

## 八、技术要点

### 8.1 性能优化
1. **Web Worker**：将耗时的优化计算放入Web Worker，避免阻塞UI
2. **增量计算**：修改单个参数时只重新计算受影响部分
3. **缓存机制**：缓存已计算的区域最优解

### 8.2 数据精度
1. 所有功率计算保留2位小数
2. 成本计算保留整数（元）
3. 百分比保留1位小数

### 8.3 边界处理
1. 设备数量为0时的处理
2. 极端天气条件下的仿真
3. 电池SOC边界（0-100%）

---

## 九、待确认事项

1. **搜索空间限制**：是否需要限制每种设备的最大数量？
2. **小组定义**：如何划分小组？按区域类型还是按学号？
3. **全局最优解范围**：允许多大的误差范围视为"找到最优解"？
4. **实时计算 vs 预计算**：是否需要预先计算所有区域的最优解？
5. **生物质路线限制**：每个区域是否只能选择一种生物质技术路线？

---

## 十、示例场景

### 场景：工业区-1 设计方案评估

**输入配置：**
- 风机：金风GW87/1500 × 8台
- 光伏：隆基Hi-MO 5 × 2000块
- 生物质：气化路线（HQ-500气化炉 + 500GF-NG燃气机）
- 储能：宁德时代280Ah × 50组
- 逆变器：华为SUN2000-100KTL × 8台

**评估结果：**
```
总分：87/100

工况满足：28/30
  - 全年可靠率：99.7%
  - 缺电时数：26小时（主要集中在1月极端天气）

设备匹配：18/20
  - 逆变器容量：800kW，光伏装机：660kW ✓
  - 气化炉-燃气机匹配 ✓
  - 储能PCS需补充配置 ⚠

经济性：26/30
  - 学生方案成本：¥1,520万
  - 最优解成本：¥1,380万
  - 差距：+10.1%

稳定性：8/10
  - 弃电率：8.2%
  - SOC波动：正常
  - 深度放电：12次

小组加分：7/10
  - 小组最优解与全局最优差距：4.2%
```

---

*文档版本：v1.0*
*创建日期：2024年*
